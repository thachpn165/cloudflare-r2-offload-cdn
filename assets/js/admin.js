(function(a){const c={init(){this.cacheElements(),this.bindEvents(),a(".cloudflare-r2-offload-cdn-form-actions").hide(),this.progressInterval=null,this.activityLogInterval=null,this.bulkStartTime=null},cacheElements(){this.$tabs=a(".cloudflare-r2-offload-cdn-tabs li"),this.$tabContents=a(".cloudflare-r2-offload-cdn-tab-content"),this.$form=a("#cloudflare-r2-offload-cdn-settings-form"),this.$saveBtn=a(".cloudflare-r2-offload-cdn-save-btn"),this.$toast=a("#cloudflare-r2-offload-cdn-toast")},bindEvents(){this.$tabs.on("click",this.handleTabClick.bind(this)),this.$form.on("submit",this.handleFormSubmit.bind(this)),a(document).on("click",".cloudflare-r2-offload-cdn-accordion-header",this.handleAccordionClick),a("#test-r2-connection").on("click",this.handleTestR2Connection.bind(this)),a("#cfr2-bulk-offload-all").on("click",this.handleBulkOffload.bind(this)),a("#cfr2-cancel-bulk").on("click",this.handleCancelBulk.bind(this)),a("#cdn_enabled").on("change",this.handleCDNToggle.bind(this)),a("#quality").on("input",this.handleQualityChange.bind(this)),a("#deploy-worker").on("click",this.handleDeployWorker.bind(this)),a("#remove-worker").on("click",this.handleRemoveWorker.bind(this)),a("#cfr2-retry-all-failed").on("click",this.handleRetryFailed.bind(this)),a("#cfr2-retry-all").on("click",this.handleRetryFailed.bind(this)),a("#cfr2-clear-log").on("click",this.handleClearLog.bind(this)),a(document).on("click",".cfr2-retry-single",this.handleRetrySingle.bind(this)),a("#goto-bulk-actions").on("click",this.handleGotoBulkActions.bind(this)),a(document).on("click",".cfr2-offload-btn",this.handleAttachmentOffload.bind(this))},handleTabClick(s){const t=a(s.currentTarget),e=t.data("tab");this.$tabs.removeClass("active"),t.addClass("active"),this.$tabContents.removeClass("active"),a("#tab-"+e).addClass("active"),a(".cloudflare-r2-offload-cdn-form-actions").toggle(e!=="dashboard"&&e!=="bulk-actions"),e==="bulk-actions"&&(this.loadActivityLog(),this.checkBulkProgress())},handleAccordionClick(s){const t=a(s.currentTarget),e=t.next(".cloudflare-r2-offload-cdn-accordion-content");t.toggleClass("active"),e.toggleClass("active")},handleFormSubmit(s){if(s.preventDefault(),this.$saveBtn.hasClass("is-loading"))return;this.setLoading(!0);const t=this.$form.serialize();a.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:t+"&action=cloudflare_r2_offload_cdn_save_settings",success:this.handleSaveSuccess.bind(this),error:this.handleSaveError.bind(this),complete:()=>this.setLoading(!1)})},handleSaveSuccess(s){s.success?this.showToast(s.data.message,"success"):this.showToast(s.data.message||myPluginAdmin.strings.error,"error")},handleSaveError(){this.showToast(myPluginAdmin.strings.error,"error")},setLoading(s){this.$saveBtn.toggleClass("is-loading",s)},showToast(s,t="success"){const e=t==="success"?"yes-alt":"warning",l=a("<div>",{class:`cloudflare-r2-offload-cdn-toast-item ${t}`}).append(a("<span>",{class:`dashicons dashicons-${e}`}),a("<span>").text(s));this.$toast.append(l),setTimeout(()=>{l.addClass("fade-out"),setTimeout(()=>l.remove(),300)},3e3)},handleTestR2Connection(s){s.preventDefault();const t=a(s.currentTarget),e=a("#r2-connection-result");t.hasClass("is-loading")||(t.addClass("is-loading").prop("disabled",!0),e.html('<span class="spinner is-active" style="float:none;margin:0 5px;"></span>'),a.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cloudflare_r2_offload_cdn_test_r2",cloudflare_r2_offload_cdn_nonce:a("#cloudflare_r2_offload_cdn_nonce").val(),r2_account_id:a("#r2_account_id").val(),r2_access_key_id:a("#r2_access_key_id").val(),r2_secret_access_key:a("#r2_secret_access_key").val(),r2_bucket:a("#r2_bucket").val()},success:l=>{l.success?(e.html('<span style="color: #46b450;">✓ '+l.data.message+"</span>"),this.showToast(l.data.message,"success")):(e.html('<span style="color: #dc3232;">✗ '+l.data.message+"</span>"),this.showToast(l.data.message,"error"))},error:()=>{e.html('<span style="color: #dc3232;">✗ Connection failed</span>'),this.showToast("Connection test failed","error")},complete:()=>{t.removeClass("is-loading").prop("disabled",!1)}}))},handleBulkOffload(s){s.preventDefault(),confirm("Queue all media files for offload to R2?")&&a.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_bulk_offload_all",nonce:a("#cloudflare_r2_offload_cdn_nonce").val()},success:t=>{t.success?(this.showToast(t.data.message,"success"),this.startProgressPolling()):this.showToast(t.data.message,"error")},error:()=>{this.showToast("Failed to start bulk offload","error")}})},handleCancelBulk(s){s.preventDefault(),confirm("Cancel bulk offload?")&&a.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_cancel_bulk",nonce:a("#cloudflare_r2_offload_cdn_nonce").val()},success:t=>{t.success?(this.showToast(t.data.message,"success"),this.stopProgressPolling()):this.showToast(t.data.message,"error")},error:()=>{this.showToast("Failed to cancel bulk offload","error")}})},startProgressPolling(){a("#cfr2-bulk-offload-all").hide(),a("#cfr2-retry-all-failed").hide(),a("#cfr2-cancel-bulk").show(),a("#cfr2-bulk-progress-section").show(),this.bulkStartTime=Date.now(),this.progressInterval=setInterval(()=>{this.updateProgress()},2e3),this.activityLogInterval=setInterval(()=>{this.loadActivityLog()},3e3),this.updateProgress(),this.loadActivityLog()},stopProgressPolling(){this.progressInterval&&(clearInterval(this.progressInterval),this.progressInterval=null),this.activityLogInterval&&(clearInterval(this.activityLogInterval),this.activityLogInterval=null),a("#cfr2-bulk-offload-all").show(),a("#cfr2-retry-all-failed").show(),a("#cfr2-cancel-bulk").hide(),a("#cfr2-bulk-progress-section").hide(),this.bulkStartTime=null},updateProgress(){a.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_get_bulk_progress",nonce:a("#cloudflare_r2_offload_cdn_nonce").val()},success:s=>{if(s.success){const t=s.data,e=t.total>0?Math.round((t.completed+t.failed)/t.total*100):0;if(a(".cfr2-progress-fill").css("width",e+"%"),a(".cfr2-progress-percentage").text(e+"%"),a(".cfr2-progress-text").html(`<span style="color: #46b450;">✓ ${t.completed} completed</span> | <span style="color: #dc3232;">✗ ${t.failed} failed</span> | <span style="color: #646970;">○ ${t.pending+t.processing} remaining</span>`),t.current_file?a("#cfr2-current-file").text(t.current_file):a("#cfr2-current-file").text("—"),this.bulkStartTime){const l=Math.floor((Date.now()-this.bulkStartTime)/1e3),o=Math.floor(l/60),r=l%60;a("#cfr2-elapsed").text(`${o}m ${r}s`)}t.is_running||(this.stopProgressPolling(),this.showToast("Bulk offload completed","success"),this.loadActivityLog(),this.loadFailedItems())}}})},handleCDNToggle(s){const t=a(s.currentTarget).is(":checked");a(".cdn-fields").toggle(t)},handleQualityChange(s){const t=a(s.currentTarget).val();a("#quality-value").text(t)},handleDeployWorker(s){s.preventDefault();const t=a(s.currentTarget),e=a("#worker-deploy-result");t.hasClass("is-loading")||(t.addClass("is-loading").prop("disabled",!0),e.html('<span class="spinner is-active" style="float:none;margin:0 5px;"></span>'),a.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_deploy_worker",nonce:a("#cloudflare_r2_offload_cdn_nonce").val()},success:l=>{l.success?(e.html('<span style="color: #46b450;">✓ '+l.data.message+"</span>"),this.showToast(l.data.message,"success"),a("#remove-worker").show(),setTimeout(()=>location.reload(),1500)):(e.html('<span style="color: #dc3232;">✗ '+l.data.message+"</span>"),this.showToast(l.data.message,"error"))},error:()=>{e.html('<span style="color: #dc3232;">✗ Deployment failed</span>'),this.showToast("Worker deployment failed","error")},complete:()=>{t.removeClass("is-loading").prop("disabled",!1)}}))},handleRemoveWorker(s){if(s.preventDefault(),!confirm("Remove deployed Worker? This will disable CDN URL rewriting."))return;const t=a(s.currentTarget),e=a("#worker-deploy-result");t.hasClass("is-loading")||(t.addClass("is-loading").prop("disabled",!0),e.html('<span class="spinner is-active" style="float:none;margin:0 5px;"></span>'),a.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_remove_worker",nonce:a("#cloudflare_r2_offload_cdn_nonce").val()},success:l=>{l.success?(e.html('<span style="color: #46b450;">✓ '+l.data.message+"</span>"),this.showToast(l.data.message,"success"),t.hide(),setTimeout(()=>location.reload(),1500)):(e.html('<span style="color: #dc3232;">✗ '+l.data.message+"</span>"),this.showToast(l.data.message,"error"))},error:()=>{e.html('<span style="color: #dc3232;">✗ Remove failed</span>'),this.showToast("Worker removal failed","error")},complete:()=>{t.removeClass("is-loading").prop("disabled",!1)}}))},loadActivityLog(){a.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_get_activity_log",nonce:a("#cloudflare_r2_offload_cdn_nonce").val(),limit:20},success:s=>{if(s.success&&s.data.logs.length>0){const t=a("#cfr2-activity-log");t.empty(),s.data.logs.forEach(e=>{const l=e.status==="success"?"✓":"✗",o=e.status==="success"?"#46b450":"#dc3232",r=new Date(e.timestamp*1e3).toLocaleTimeString(),n=a(`<div class="cfr2-log-entry cfr2-log-${e.status}">
                <span class="cfr2-log-time">${r}</span>
                <span class="cfr2-log-status" style="color: ${o};">${l}</span>
                <span class="cfr2-log-filename">${e.filename}</span>
                <span class="cfr2-log-message">${e.message}</span>
              </div>`);t.append(n)}),t.scrollTop(t[0].scrollHeight)}}})},checkBulkProgress(){a.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_get_bulk_progress",nonce:a("#cloudflare_r2_offload_cdn_nonce").val()},success:s=>{s.success&&s.data.is_running&&this.startProgressPolling()}})},loadFailedItems(){},handleRetryFailed(s){s.preventDefault(),confirm("Retry all failed items?")&&a.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_retry_failed",nonce:a("#cloudflare_r2_offload_cdn_nonce").val()},success:t=>{t.success?(this.showToast(t.data.message,"success"),this.startProgressPolling()):this.showToast(t.data.message,"error")},error:()=>{this.showToast("Failed to retry items","error")}})},handleRetrySingle(s){s.preventDefault();const t=a(s.currentTarget).data("attachment-id");a.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_retry_single",nonce:a("#cloudflare_r2_offload_cdn_nonce").val(),attachment_id:t},success:e=>{e.success?(this.showToast(e.data.message,"success"),a(s.currentTarget).closest(".cfr2-error-item").fadeOut()):this.showToast(e.data.message,"error")},error:()=>{this.showToast("Failed to retry item","error")}})},handleAttachmentOffload(s){s.preventDefault();const t=a(s.currentTarget),e=t.data("id"),l=t.data("nonce"),o=t.siblings(".cfr2-offload-status");t.prop("disabled",!0).text("Offloading..."),o.html('<span class="spinner is-active" style="float: none;"></span>'),a.ajax({url:ajaxurl,type:"POST",data:{action:"cfr2_offload_attachment",attachment_id:e,nonce:l},success:r=>{r.success?(o.html('<span style="color: #46b450;">✓ '+r.data.message+"</span>"),t.hide(),setTimeout(()=>{t.closest("td").find("span").first().html('<span style="color: #46b450; font-weight: bold;"><span class="dashicons dashicons-cloud" style="vertical-align: middle;"></span> Offloaded to R2</span>'+(r.data.url?'<br><small style="color: #666;">'+r.data.url+"</small>":"")),o.empty()},2e3)):(o.html('<span style="color: #dc3232;">✗ '+r.data.message+"</span>"),t.prop("disabled",!1).text("Offload to R2"))},error:()=>{o.html('<span style="color: #dc3232;">✗ Request failed</span>'),t.prop("disabled",!1).text("Offload to R2")}})},handleClearLog(s){s.preventDefault(),confirm("Clear activity log?")&&a.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_clear_log",nonce:a("#cloudflare_r2_offload_cdn_nonce").val()},success:t=>{t.success?(this.showToast(t.data.message,"success"),a("#cfr2-activity-log").html('<p class="cfr2-no-data">No recent activity.</p>')):this.showToast(t.data.message,"error")},error:()=>{this.showToast("Failed to clear log","error")}})},handleGotoBulkActions(s){s.preventDefault(),a('.cloudflare-r2-offload-cdn-tabs li[data-tab="bulk-actions"]').trigger("click")}};a(document).ready(()=>{c.init()})})(jQuery);
//# sourceMappingURL=admin.js.map
