(function(a){const i={init(){this.cacheElements(),this.bindEvents(),a(".cloudflare-r2-offload-cdn-form-actions").hide(),this.progressInterval=null,this.activityLogInterval=null,this.bulkStartTime=null},cacheElements(){this.$tabs=a(".cloudflare-r2-offload-cdn-tabs li"),this.$tabContents=a(".cloudflare-r2-offload-cdn-tab-content"),this.$form=a("#cloudflare-r2-offload-cdn-settings-form"),this.$saveBtn=a(".cloudflare-r2-offload-cdn-save-btn"),this.$toast=a("#cloudflare-r2-offload-cdn-toast")},bindEvents(){this.$tabs.on("click",this.handleTabClick.bind(this)),this.$form.on("submit",this.handleFormSubmit.bind(this)),a(document).on("click",".cloudflare-r2-offload-cdn-accordion-header",this.handleAccordionClick),a("#test-r2-connection").on("click",this.handleTestR2Connection.bind(this)),a("#cfr2-bulk-offload-all").on("click",this.handleBulkOffload.bind(this)),a("#cfr2-cancel-bulk").on("click",this.handleCancelBulk.bind(this)),a("#cdn_enabled").on("change",this.handleCDNToggle.bind(this)),a("#quality").on("input",this.handleQualityChange.bind(this)),a("#deploy-worker").on("click",this.handleDeployWorker.bind(this)),a("#remove-worker").on("click",this.handleRemoveWorker.bind(this)),a("#cfr2-retry-all-failed").on("click",this.handleRetryFailed.bind(this)),a("#cfr2-retry-all").on("click",this.handleRetryFailed.bind(this)),a("#cfr2-clear-log").on("click",this.handleClearLog.bind(this)),a(document).on("click",".cfr2-retry-single",this.handleRetrySingle.bind(this)),a("#goto-bulk-actions").on("click",this.handleGotoBulkActions.bind(this))},handleTabClick(t){const s=a(t.currentTarget),e=s.data("tab");this.$tabs.removeClass("active"),s.addClass("active"),this.$tabContents.removeClass("active"),a("#tab-"+e).addClass("active"),a(".cloudflare-r2-offload-cdn-form-actions").toggle(e!=="dashboard"&&e!=="bulk-actions"),e==="bulk-actions"&&(this.loadActivityLog(),this.checkBulkProgress())},handleAccordionClick(t){const s=a(t.currentTarget),e=s.next(".cloudflare-r2-offload-cdn-accordion-content");s.toggleClass("active"),e.toggleClass("active")},handleFormSubmit(t){if(t.preventDefault(),this.$saveBtn.hasClass("is-loading"))return;this.setLoading(!0);const s=this.$form.serialize();a.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:s+"&action=cloudflare_r2_offload_cdn_save_settings",success:this.handleSaveSuccess.bind(this),error:this.handleSaveError.bind(this),complete:()=>this.setLoading(!1)})},handleSaveSuccess(t){t.success?this.showToast(t.data.message,"success"):this.showToast(t.data.message||myPluginAdmin.strings.error,"error")},handleSaveError(){this.showToast(myPluginAdmin.strings.error,"error")},setLoading(t){this.$saveBtn.toggleClass("is-loading",t)},showToast(t,s="success"){const e=s==="success"?"yes-alt":"warning",l=a("<div>",{class:`cloudflare-r2-offload-cdn-toast-item ${s}`}).append(a("<span>",{class:`dashicons dashicons-${e}`}),a("<span>").text(t));this.$toast.append(l),setTimeout(()=>{l.addClass("fade-out"),setTimeout(()=>l.remove(),300)},3e3)},handleTestR2Connection(t){t.preventDefault();const s=a(t.currentTarget),e=a("#r2-connection-result");s.hasClass("is-loading")||(s.addClass("is-loading").prop("disabled",!0),e.html('<span class="spinner is-active" style="float:none;margin:0 5px;"></span>'),a.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cloudflare_r2_offload_cdn_test_r2",cloudflare_r2_offload_cdn_nonce:a("#cloudflare_r2_offload_cdn_nonce").val()},success:l=>{l.success?(e.html('<span style="color: #46b450;">✓ '+l.data.message+"</span>"),this.showToast(l.data.message,"success")):(e.html('<span style="color: #dc3232;">✗ '+l.data.message+"</span>"),this.showToast(l.data.message,"error"))},error:()=>{e.html('<span style="color: #dc3232;">✗ Connection failed</span>'),this.showToast("Connection test failed","error")},complete:()=>{s.removeClass("is-loading").prop("disabled",!1)}}))},handleBulkOffload(t){t.preventDefault(),confirm("Queue all media files for offload to R2?")&&a.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_bulk_offload_all",nonce:a("#cloudflare_r2_offload_cdn_nonce").val()},success:s=>{s.success?(this.showToast(s.data.message,"success"),this.startProgressPolling()):this.showToast(s.data.message,"error")},error:()=>{this.showToast("Failed to start bulk offload","error")}})},handleCancelBulk(t){t.preventDefault(),confirm("Cancel bulk offload?")&&a.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_cancel_bulk",nonce:a("#cloudflare_r2_offload_cdn_nonce").val()},success:s=>{s.success?(this.showToast(s.data.message,"success"),this.stopProgressPolling()):this.showToast(s.data.message,"error")},error:()=>{this.showToast("Failed to cancel bulk offload","error")}})},startProgressPolling(){a("#cfr2-bulk-offload-all").hide(),a("#cfr2-retry-all-failed").hide(),a("#cfr2-cancel-bulk").show(),a("#cfr2-bulk-progress-section").show(),this.bulkStartTime=Date.now(),this.progressInterval=setInterval(()=>{this.updateProgress()},2e3),this.activityLogInterval=setInterval(()=>{this.loadActivityLog()},3e3),this.updateProgress(),this.loadActivityLog()},stopProgressPolling(){this.progressInterval&&(clearInterval(this.progressInterval),this.progressInterval=null),this.activityLogInterval&&(clearInterval(this.activityLogInterval),this.activityLogInterval=null),a("#cfr2-bulk-offload-all").show(),a("#cfr2-retry-all-failed").show(),a("#cfr2-cancel-bulk").hide(),a("#cfr2-bulk-progress-section").hide(),this.bulkStartTime=null},updateProgress(){a.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_get_bulk_progress",nonce:a("#cloudflare_r2_offload_cdn_nonce").val()},success:t=>{if(t.success){const s=t.data,e=s.total>0?Math.round((s.completed+s.failed)/s.total*100):0;if(a(".cfr2-progress-fill").css("width",e+"%"),a(".cfr2-progress-percentage").text(e+"%"),a(".cfr2-progress-text").html(`<span style="color: #46b450;">✓ ${s.completed} completed</span> | <span style="color: #dc3232;">✗ ${s.failed} failed</span> | <span style="color: #646970;">○ ${s.pending+s.processing} remaining</span>`),s.current_file?a("#cfr2-current-file").text(s.current_file):a("#cfr2-current-file").text("—"),this.bulkStartTime){const l=Math.floor((Date.now()-this.bulkStartTime)/1e3),o=Math.floor(l/60),r=l%60;a("#cfr2-elapsed").text(`${o}m ${r}s`)}s.is_running||(this.stopProgressPolling(),this.showToast("Bulk offload completed","success"),this.loadActivityLog(),this.loadFailedItems())}}})},handleCDNToggle(t){const s=a(t.currentTarget).is(":checked");a(".cdn-fields").toggle(s)},handleQualityChange(t){const s=a(t.currentTarget).val();a("#quality-value").text(s)},handleDeployWorker(t){t.preventDefault();const s=a(t.currentTarget),e=a("#worker-deploy-result");s.hasClass("is-loading")||(s.addClass("is-loading").prop("disabled",!0),e.html('<span class="spinner is-active" style="float:none;margin:0 5px;"></span>'),a.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_deploy_worker",nonce:a("#cloudflare_r2_offload_cdn_nonce").val()},success:l=>{l.success?(e.html('<span style="color: #46b450;">✓ '+l.data.message+"</span>"),this.showToast(l.data.message,"success"),a("#remove-worker").show(),setTimeout(()=>location.reload(),1500)):(e.html('<span style="color: #dc3232;">✗ '+l.data.message+"</span>"),this.showToast(l.data.message,"error"))},error:()=>{e.html('<span style="color: #dc3232;">✗ Deployment failed</span>'),this.showToast("Worker deployment failed","error")},complete:()=>{s.removeClass("is-loading").prop("disabled",!1)}}))},handleRemoveWorker(t){if(t.preventDefault(),!confirm("Remove deployed Worker? This will disable CDN URL rewriting."))return;const s=a(t.currentTarget),e=a("#worker-deploy-result");s.hasClass("is-loading")||(s.addClass("is-loading").prop("disabled",!0),e.html('<span class="spinner is-active" style="float:none;margin:0 5px;"></span>'),a.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_remove_worker",nonce:a("#cloudflare_r2_offload_cdn_nonce").val()},success:l=>{l.success?(e.html('<span style="color: #46b450;">✓ '+l.data.message+"</span>"),this.showToast(l.data.message,"success"),s.hide(),setTimeout(()=>location.reload(),1500)):(e.html('<span style="color: #dc3232;">✗ '+l.data.message+"</span>"),this.showToast(l.data.message,"error"))},error:()=>{e.html('<span style="color: #dc3232;">✗ Remove failed</span>'),this.showToast("Worker removal failed","error")},complete:()=>{s.removeClass("is-loading").prop("disabled",!1)}}))},loadActivityLog(){a.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_get_activity_log",nonce:a("#cloudflare_r2_offload_cdn_nonce").val(),limit:20},success:t=>{if(t.success&&t.data.logs.length>0){const s=a("#cfr2-activity-log");s.empty(),t.data.logs.forEach(e=>{const l=e.status==="success"?"✓":"✗",o=e.status==="success"?"#46b450":"#dc3232",r=new Date(e.timestamp*1e3).toLocaleTimeString(),n=a(`<div class="cfr2-log-entry cfr2-log-${e.status}">
                <span class="cfr2-log-time">${r}</span>
                <span class="cfr2-log-status" style="color: ${o};">${l}</span>
                <span class="cfr2-log-filename">${e.filename}</span>
                <span class="cfr2-log-message">${e.message}</span>
              </div>`);s.append(n)}),s.scrollTop(s[0].scrollHeight)}}})},checkBulkProgress(){a.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_get_bulk_progress",nonce:a("#cloudflare_r2_offload_cdn_nonce").val()},success:t=>{t.success&&t.data.is_running&&this.startProgressPolling()}})},loadFailedItems(){},handleRetryFailed(t){t.preventDefault(),confirm("Retry all failed items?")&&a.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_retry_failed",nonce:a("#cloudflare_r2_offload_cdn_nonce").val()},success:s=>{s.success?(this.showToast(s.data.message,"success"),this.startProgressPolling()):this.showToast(s.data.message,"error")},error:()=>{this.showToast("Failed to retry items","error")}})},handleRetrySingle(t){t.preventDefault();const s=a(t.currentTarget).data("attachment-id");a.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_retry_single",nonce:a("#cloudflare_r2_offload_cdn_nonce").val(),attachment_id:s},success:e=>{e.success?(this.showToast(e.data.message,"success"),a(t.currentTarget).closest(".cfr2-error-item").fadeOut()):this.showToast(e.data.message,"error")},error:()=>{this.showToast("Failed to retry item","error")}})},handleClearLog(t){t.preventDefault(),confirm("Clear activity log?")&&a.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_clear_log",nonce:a("#cloudflare_r2_offload_cdn_nonce").val()},success:s=>{s.success?(this.showToast(s.data.message,"success"),a("#cfr2-activity-log").html('<p class="cfr2-no-data">No recent activity.</p>')):this.showToast(s.data.message,"error")},error:()=>{this.showToast("Failed to clear log","error")}})},handleGotoBulkActions(t){t.preventDefault(),a('.cloudflare-r2-offload-cdn-tabs li[data-tab="bulk-actions"]').trigger("click")}};a(document).ready(()=>{i.init()})})(jQuery);
//# sourceMappingURL=admin.js.map
