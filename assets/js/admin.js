(function(s){const r={init(){this.cacheElements(),this.bindEvents(),s(".cloudflare-r2-offload-cdn-form-actions").hide(),this.progressInterval=null,this.activityLogInterval=null,this.bulkStartTime=null},cacheElements(){this.$tabs=s(".cloudflare-r2-offload-cdn-tabs li"),this.$tabContents=s(".cloudflare-r2-offload-cdn-tab-content"),this.$form=s("#cloudflare-r2-offload-cdn-settings-form"),this.$saveBtn=s(".cloudflare-r2-offload-cdn-save-btn"),this.$toast=s("#cloudflare-r2-offload-cdn-toast")},bindEvents(){this.$tabs.on("click",this.handleTabClick.bind(this)),this.$form.on("submit",this.handleFormSubmit.bind(this)),s(document).on("click",".cloudflare-r2-offload-cdn-accordion-header",this.handleAccordionClick),s("#test-r2-connection").on("click",this.handleTestR2Connection.bind(this)),s("#cfr2-bulk-offload-all").on("click",this.handleBulkOffload.bind(this)),s("#cfr2-cancel-bulk").on("click",this.handleCancelBulk.bind(this)),s("#cdn_enabled").on("change",this.handleCDNToggle.bind(this)),s("#smart_sizes").on("change",this.handleSmartSizesToggle.bind(this)),s("#quality").on("input",this.handleQualityChange.bind(this)),s("#deploy-worker").on("click",this.handleDeployWorker.bind(this)),s("#remove-worker").on("click",this.handleRemoveWorker.bind(this)),s("#cfr2-retry-all-failed").on("click",this.handleRetryFailed.bind(this)),s("#cfr2-retry-all").on("click",this.handleRetryFailed.bind(this)),s("#cfr2-clear-log").on("click",this.handleClearLog.bind(this)),s(document).on("click",".cfr2-retry-single",this.handleRetrySingle.bind(this)),s("#goto-bulk-actions").on("click",this.handleGotoBulkActions.bind(this)),s(document).on("click",".cfr2-offload-btn",this.handleAttachmentOffload.bind(this)),s("#validate-cdn-dns").on("click",this.handleValidateCdnDns.bind(this)),s(document).on("click",".cfr2-enable-proxy-btn",this.handleEnableDnsProxy.bind(this))},handleTabClick(t){const a=s(t.currentTarget),e=a.data("tab");this.$tabs.removeClass("active"),a.addClass("active"),this.$tabContents.removeClass("active"),s("#tab-"+e).addClass("active"),s(".cloudflare-r2-offload-cdn-form-actions").toggle(e!=="dashboard"&&e!=="bulk-actions"),e==="bulk-actions"&&(this.loadActivityLog(),this.checkBulkProgress())},handleAccordionClick(t){const a=s(t.currentTarget),e=a.next(".cloudflare-r2-offload-cdn-accordion-content");a.toggleClass("active"),e.toggleClass("active")},handleFormSubmit(t){if(t.preventDefault(),this.$saveBtn.hasClass("is-loading"))return;this.setLoading(!0);const a=this.$form.serialize();s.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:a+"&action=cloudflare_r2_offload_cdn_save_settings",success:this.handleSaveSuccess.bind(this),error:this.handleSaveError.bind(this),complete:()=>this.setLoading(!1)})},handleSaveSuccess(t){t.success?this.showToast(t.data.message,"success"):this.showToast(t.data.message||myPluginAdmin.strings.error,"error")},handleSaveError(){this.showToast(myPluginAdmin.strings.error,"error")},setLoading(t){this.$saveBtn.toggleClass("is-loading",t)},showToast(t,a="success"){const e=a==="success"?"yes-alt":"warning",l=s("<div>",{class:`cloudflare-r2-offload-cdn-toast-item ${a}`}).append(s("<span>",{class:`dashicons dashicons-${e}`}),s("<span>").text(t));this.$toast.append(l),setTimeout(()=>{l.addClass("fade-out"),setTimeout(()=>l.remove(),300)},3e3)},handleTestR2Connection(t){t.preventDefault();const a=s(t.currentTarget),e=s("#r2-connection-result");a.hasClass("is-loading")||(a.addClass("is-loading").prop("disabled",!0),e.html('<span class="spinner is-active" style="float:none;margin:0 5px;"></span>'),s.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cloudflare_r2_offload_cdn_test_r2",cloudflare_r2_offload_cdn_nonce:s("#cloudflare_r2_offload_cdn_nonce").val(),r2_account_id:s("#r2_account_id").val(),r2_access_key_id:s("#r2_access_key_id").val(),r2_secret_access_key:s("#r2_secret_access_key").val(),r2_bucket:s("#r2_bucket").val()},success:l=>{l.success?(e.html('<span style="color: #46b450;">✓ '+l.data.message+"</span>"),this.showToast(l.data.message,"success")):(e.html('<span style="color: #dc3232;">✗ '+l.data.message+"</span>"),this.showToast(l.data.message,"error"))},error:()=>{e.html('<span style="color: #dc3232;">✗ Connection failed</span>'),this.showToast("Connection test failed","error")},complete:()=>{a.removeClass("is-loading").prop("disabled",!1)}}))},handleBulkOffload(t){t.preventDefault(),confirm("Queue all media files for offload to R2?")&&s.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_bulk_offload_all",nonce:s("#cloudflare_r2_offload_cdn_nonce").val()},success:a=>{a.success?(this.showToast(a.data.message,"success"),this.startProgressPolling()):this.showToast(a.data.message,"error")},error:()=>{this.showToast("Failed to start bulk offload","error")}})},handleCancelBulk(t){t.preventDefault(),confirm("Cancel bulk offload?")&&s.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_cancel_bulk",nonce:s("#cloudflare_r2_offload_cdn_nonce").val()},success:a=>{a.success?(this.showToast(a.data.message,"success"),this.stopProgressPolling()):this.showToast(a.data.message,"error")},error:()=>{this.showToast("Failed to cancel bulk offload","error")}})},startProgressPolling(){s("#cfr2-bulk-offload-all").hide(),s("#cfr2-retry-all-failed").hide(),s("#cfr2-cancel-bulk").show(),s("#cfr2-bulk-progress-section").show(),this.bulkStartTime=Date.now(),this.progressInterval=setInterval(()=>{this.updateProgress()},2e3),this.activityLogInterval=setInterval(()=>{this.loadActivityLog()},3e3),this.updateProgress(),this.loadActivityLog()},stopProgressPolling(){this.progressInterval&&(clearInterval(this.progressInterval),this.progressInterval=null),this.activityLogInterval&&(clearInterval(this.activityLogInterval),this.activityLogInterval=null),s("#cfr2-bulk-offload-all").show(),s("#cfr2-retry-all-failed").show(),s("#cfr2-cancel-bulk").hide(),s("#cfr2-bulk-progress-section").hide(),this.bulkStartTime=null},updateProgress(){s.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_get_bulk_progress",nonce:s("#cloudflare_r2_offload_cdn_nonce").val()},success:t=>{if(t.success){const a=t.data,e=a.total>0?Math.round((a.completed+a.failed)/a.total*100):0;if(s(".cfr2-progress-fill").css("width",e+"%"),s(".cfr2-progress-percentage").text(e+"%"),s(".cfr2-progress-text").html(`<span style="color: #46b450;">✓ ${a.completed} completed</span> | <span style="color: #dc3232;">✗ ${a.failed} failed</span> | <span style="color: #646970;">○ ${a.pending+a.processing} remaining</span>`),a.current_file?s("#cfr2-current-file").text(a.current_file):s("#cfr2-current-file").text("—"),this.bulkStartTime){const l=Math.floor((Date.now()-this.bulkStartTime)/1e3),n=Math.floor(l/60),o=l%60;s("#cfr2-elapsed").text(`${n}m ${o}s`)}a.is_running||(this.stopProgressPolling(),this.showToast("Bulk offload completed","success"),this.loadActivityLog(),this.loadFailedItems())}}})},handleCDNToggle(t){const a=s(t.currentTarget).is(":checked");s(".cdn-fields").toggle(a)},handleSmartSizesToggle(t){const a=s(t.currentTarget).is(":checked");s(".smart-sizes-options").toggle(a)},handleQualityChange(t){const a=s(t.currentTarget).val();s("#quality-value").text(a)},handleDeployWorker(t){t.preventDefault();const a=s(t.currentTarget),e=s("#worker-deploy-result");a.hasClass("is-loading")||(a.addClass("is-loading").prop("disabled",!0),e.html('<span class="spinner is-active" style="float:none;margin:0 5px;"></span>'),s.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_deploy_worker",nonce:s("#cloudflare_r2_offload_cdn_nonce").val()},success:l=>{l.success?(e.html('<span style="color: #46b450;">✓ '+l.data.message+"</span>"),this.showToast(l.data.message,"success"),s("#remove-worker").show(),setTimeout(()=>location.reload(),1500)):(e.html('<span style="color: #dc3232;">✗ '+l.data.message+"</span>"),this.showToast(l.data.message,"error"))},error:()=>{e.html('<span style="color: #dc3232;">✗ Deployment failed</span>'),this.showToast("Worker deployment failed","error")},complete:()=>{a.removeClass("is-loading").prop("disabled",!1)}}))},handleRemoveWorker(t){if(t.preventDefault(),!confirm("Remove deployed Worker? This will disable CDN URL rewriting."))return;const a=s(t.currentTarget),e=s("#worker-deploy-result");a.hasClass("is-loading")||(a.addClass("is-loading").prop("disabled",!0),e.html('<span class="spinner is-active" style="float:none;margin:0 5px;"></span>'),s.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_remove_worker",nonce:s("#cloudflare_r2_offload_cdn_nonce").val()},success:l=>{l.success?(e.html('<span style="color: #46b450;">✓ '+l.data.message+"</span>"),this.showToast(l.data.message,"success"),a.hide(),setTimeout(()=>location.reload(),1500)):(e.html('<span style="color: #dc3232;">✗ '+l.data.message+"</span>"),this.showToast(l.data.message,"error"))},error:()=>{e.html('<span style="color: #dc3232;">✗ Remove failed</span>'),this.showToast("Worker removal failed","error")},complete:()=>{a.removeClass("is-loading").prop("disabled",!1)}}))},loadActivityLog(){s.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_get_activity_log",nonce:s("#cloudflare_r2_offload_cdn_nonce").val(),limit:20},success:t=>{if(t.success&&t.data.logs.length>0){const a=s("#cfr2-activity-log");a.empty(),t.data.logs.forEach(e=>{const l=e.status==="success"?"✓":"✗",n=e.status==="success"?"#46b450":"#dc3232",o=new Date(e.timestamp*1e3).toLocaleTimeString(),i=s(`<div class="cfr2-log-entry cfr2-log-${e.status}">
                <span class="cfr2-log-time">${o}</span>
                <span class="cfr2-log-status" style="color: ${n};">${l}</span>
                <span class="cfr2-log-filename">${e.filename}</span>
                <span class="cfr2-log-message">${e.message}</span>
              </div>`);a.append(i)}),a.scrollTop(a[0].scrollHeight)}}})},checkBulkProgress(){s.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_get_bulk_progress",nonce:s("#cloudflare_r2_offload_cdn_nonce").val()},success:t=>{t.success&&t.data.is_running&&this.startProgressPolling()}})},loadFailedItems(){},handleRetryFailed(t){t.preventDefault(),confirm("Retry all failed items?")&&s.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_retry_failed",nonce:s("#cloudflare_r2_offload_cdn_nonce").val()},success:a=>{a.success?(this.showToast(a.data.message,"success"),this.startProgressPolling()):this.showToast(a.data.message,"error")},error:()=>{this.showToast("Failed to retry items","error")}})},handleRetrySingle(t){t.preventDefault();const a=s(t.currentTarget).data("attachment-id");s.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_retry_single",nonce:s("#cloudflare_r2_offload_cdn_nonce").val(),attachment_id:a},success:e=>{e.success?(this.showToast(e.data.message,"success"),s(t.currentTarget).closest(".cfr2-error-item").fadeOut()):this.showToast(e.data.message,"error")},error:()=>{this.showToast("Failed to retry item","error")}})},handleAttachmentOffload(t){t.preventDefault();const a=s(t.currentTarget),e=a.data("id"),l=a.data("nonce"),n=a.siblings(".cfr2-offload-status");a.prop("disabled",!0).text("Offloading..."),n.html('<span class="spinner is-active" style="float: none;"></span>'),s.ajax({url:ajaxurl,type:"POST",data:{action:"cfr2_offload_attachment",attachment_id:e,nonce:l},success:o=>{o.success?(n.html('<span style="color: #46b450;">✓ '+o.data.message+"</span>"),a.hide(),setTimeout(()=>{a.closest("td").find("span").first().html('<span style="color: #46b450; font-weight: bold;"><span class="dashicons dashicons-cloud" style="vertical-align: middle;"></span> Offloaded to R2</span>'+(o.data.url?'<br><small style="color: #666;">'+o.data.url+"</small>":"")),n.empty()},2e3)):(n.html('<span style="color: #dc3232;">✗ '+o.data.message+"</span>"),a.prop("disabled",!1).text("Offload to R2"))},error:()=>{n.html('<span style="color: #dc3232;">✗ Request failed</span>'),a.prop("disabled",!1).text("Offload to R2")}})},handleClearLog(t){t.preventDefault(),confirm("Clear activity log?")&&s.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_clear_log",nonce:s("#cloudflare_r2_offload_cdn_nonce").val()},success:a=>{a.success?(this.showToast(a.data.message,"success"),s("#cfr2-activity-log").html('<p class="cfr2-no-data">No recent activity.</p>')):this.showToast(a.data.message,"error")},error:()=>{this.showToast("Failed to clear log","error")}})},handleGotoBulkActions(t){t.preventDefault(),s('.cloudflare-r2-offload-cdn-tabs li[data-tab="bulk-actions"]').trigger("click")},handleValidateCdnDns(t){t.preventDefault();const a=s(t.currentTarget),e=s("#cdn-dns-status"),l=s("#cdn_url").val();if(!l){this.showToast("Please enter a CDN URL first","error");return}a.hasClass("is-loading")||(a.addClass("is-loading").prop("disabled",!0).text("Validating..."),e.show().html('<span class="spinner is-active" style="float:none;margin:0 5px;"></span> Checking DNS...'),s.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_validate_cdn_dns",nonce:s("#cloudflare_r2_offload_cdn_nonce").val(),cdn_url:l},success:n=>{if(n.success){const o=n.data;o.action==="created"?(e.html('<div class="cfr2-dns-success"><span class="dashicons dashicons-yes-alt" style="color: #46b450;"></span> '+o.message+"</div>"),this.showToast(o.message,"success")):o.action==="exists"&&(o.warnings&&o.warnings.length>0?(e.html('<div class="cfr2-dns-warning"><span class="dashicons dashicons-warning" style="color: #dba617;"></span> '+o.warnings.join("<br>")+'<br><button type="button" class="button cfr2-enable-proxy-btn" data-zone-id="'+o.zone_id+'" data-record-id="'+o.record_id+'">Enable Proxy Now</button></div>'),this.showToast("DNS record found but needs configuration","error")):(e.html('<div class="cfr2-dns-success"><span class="dashicons dashicons-yes-alt" style="color: #46b450;"></span> DNS record found with proxy enabled. Ready to deploy!</div>'),this.showToast("DNS validation passed!","success")))}else e.html('<div class="cfr2-dns-error"><span class="dashicons dashicons-dismiss" style="color: #dc3232;"></span> '+n.data.message+"</div>"),this.showToast(n.data.message,"error")},error:()=>{e.html('<div class="cfr2-dns-error"><span class="dashicons dashicons-dismiss" style="color: #dc3232;"></span> Validation request failed</div>'),this.showToast("DNS validation failed","error")},complete:()=>{a.removeClass("is-loading").prop("disabled",!1).text("Validate DNS")}}))},handleEnableDnsProxy(t){t.preventDefault();const a=s(t.currentTarget),e=a.data("zone-id"),l=a.data("record-id"),n=s("#cdn-dns-status");a.hasClass("is-loading")||(a.addClass("is-loading").prop("disabled",!0).text("Enabling..."),s.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_enable_dns_proxy",nonce:s("#cloudflare_r2_offload_cdn_nonce").val(),zone_id:e,record_id:l},success:o=>{o.success?(n.html('<div class="cfr2-dns-success"><span class="dashicons dashicons-yes-alt" style="color: #46b450;"></span> '+o.data.message+" Ready to deploy!</div>"),this.showToast(o.data.message,"success")):(this.showToast(o.data.message,"error"),a.removeClass("is-loading").prop("disabled",!1).text("Enable Proxy Now"))},error:()=>{this.showToast("Failed to enable proxy","error"),a.removeClass("is-loading").prop("disabled",!1).text("Enable Proxy Now")}}))}};s(document).ready(()=>{r.init()})})(jQuery);
//# sourceMappingURL=admin.js.map
