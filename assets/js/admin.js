(function(s){const r={init(){this.cacheElements(),this.bindEvents(),s(".cloudflare-r2-offload-cdn-form-actions").hide(),this.progressInterval=null,this.activityLogInterval=null,this.bulkStartTime=null,this.bulkStats={completed:0,failed:0,total:0},this.isProcessing=!1},cacheElements(){this.$tabs=s(".cloudflare-r2-offload-cdn-tabs li"),this.$tabContents=s(".cloudflare-r2-offload-cdn-tab-content"),this.$form=s("#cloudflare-r2-offload-cdn-settings-form"),this.$saveBtn=s(".cloudflare-r2-offload-cdn-save-btn"),this.$toast=s("#cloudflare-r2-offload-cdn-toast")},bindEvents(){this.$tabs.on("click",this.handleTabClick.bind(this)),this.$form.on("submit",this.handleFormSubmit.bind(this)),s(document).on("click",".cloudflare-r2-offload-cdn-accordion-header",this.handleAccordionClick),s("#test-r2-connection").on("click",this.handleTestR2Connection.bind(this)),s("#cfr2-bulk-offload-all").on("click",this.handleBulkOffload.bind(this)),s("#cfr2-cancel-bulk").on("click",this.handleCancelBulk.bind(this)),s("#cdn_enabled").on("change",this.handleCDNToggle.bind(this)),s("#smart_sizes").on("change",this.handleSmartSizesToggle.bind(this)),s("#quality").on("input",this.handleQualityChange.bind(this)),s("#deploy-worker").on("click",this.handleDeployWorker.bind(this)),s("#remove-worker").on("click",this.handleRemoveWorker.bind(this)),s("#cfr2-retry-all-failed").on("click",this.handleRetryFailed.bind(this)),s("#cfr2-retry-all").on("click",this.handleRetryFailed.bind(this)),s("#cfr2-clear-log").on("click",this.handleClearLog.bind(this)),s(document).on("click",".cfr2-retry-single",this.handleRetrySingle.bind(this)),s("#goto-bulk-actions").on("click",this.handleGotoBulkActions.bind(this)),s(document).on("click",".cfr2-offload-btn",this.handleAttachmentOffload.bind(this)),s("#validate-cdn-dns").on("click",this.handleValidateCdnDns.bind(this)),s(document).on("click",".cfr2-enable-proxy-btn",this.handleEnableDnsProxy.bind(this))},handleTabClick(e){const a=s(e.currentTarget),t=a.data("tab");this.$tabs.removeClass("active"),a.addClass("active"),this.$tabContents.removeClass("active"),s("#tab-"+t).addClass("active"),s(".cloudflare-r2-offload-cdn-form-actions").toggle(t!=="dashboard"&&t!=="bulk-actions"),t==="bulk-actions"&&(this.loadActivityLog(),this.checkBulkProgress())},handleAccordionClick(e){const a=s(e.currentTarget),t=a.next(".cloudflare-r2-offload-cdn-accordion-content");a.toggleClass("active"),t.toggleClass("active")},handleFormSubmit(e){if(e.preventDefault(),this.$saveBtn.hasClass("is-loading"))return;this.setLoading(!0);const a=this.$form.serialize();s.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:a+"&action=cloudflare_r2_offload_cdn_save_settings",success:this.handleSaveSuccess.bind(this),error:this.handleSaveError.bind(this),complete:()=>this.setLoading(!1)})},handleSaveSuccess(e){e.success?this.showToast(e.data.message,"success"):this.showToast(e.data.message||myPluginAdmin.strings.error,"error")},handleSaveError(){this.showToast(myPluginAdmin.strings.error,"error")},setLoading(e){this.$saveBtn.toggleClass("is-loading",e)},showToast(e,a="success"){const t=a==="success"?"yes-alt":"warning",l=s("<div>",{class:`cloudflare-r2-offload-cdn-toast-item ${a}`}).append(s("<span>",{class:`dashicons dashicons-${t}`}),s("<span>").text(e));this.$toast.append(l),setTimeout(()=>{l.addClass("fade-out"),setTimeout(()=>l.remove(),300)},3e3)},handleTestR2Connection(e){e.preventDefault();const a=s(e.currentTarget),t=s("#r2-connection-result");a.hasClass("is-loading")||(a.addClass("is-loading").prop("disabled",!0),t.html('<span class="spinner is-active" style="float:none;margin:0 5px;"></span>'),s.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cloudflare_r2_offload_cdn_test_r2",cloudflare_r2_offload_cdn_nonce:s("#cloudflare_r2_offload_cdn_nonce").val(),r2_account_id:s("#r2_account_id").val(),r2_access_key_id:s("#r2_access_key_id").val(),r2_secret_access_key:s("#r2_secret_access_key").val(),r2_bucket:s("#r2_bucket").val()},success:l=>{l.success?(t.html('<span style="color: #46b450;">✓ '+l.data.message+"</span>"),this.showToast(l.data.message,"success")):(t.html('<span style="color: #dc3232;">✗ '+l.data.message+"</span>"),this.showToast(l.data.message,"error"))},error:()=>{t.html('<span style="color: #dc3232;">✗ Connection failed</span>'),this.showToast("Connection test failed","error")},complete:()=>{a.removeClass("is-loading").prop("disabled",!1)}}))},handleBulkOffload(e){if(e.preventDefault(),!confirm("Queue all media files for offload to R2?"))return;const a=s(e.currentTarget);a.prop("disabled",!0).text("Queuing..."),s.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_bulk_offload_all",nonce:s("#cloudflare_r2_offload_cdn_nonce").val()},success:t=>{t.success?(this.terminalLog("info",`Queued ${t.data.total} files for offload.`),this.bulkStats={completed:0,failed:0,total:t.data.total},this.startBulkProcessing()):(this.terminalLog("error",t.data.message),this.showToast(t.data.message,"error"),a.prop("disabled",!1).text("Offload All Media"))},error:()=>{this.terminalLog("error","Failed to queue files."),this.showToast("Failed to start bulk offload","error"),a.prop("disabled",!1).text("Offload All Media")}})},handleCancelBulk(e){e.preventDefault(),confirm("Cancel bulk offload?")&&s.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_cancel_bulk",nonce:s("#cloudflare_r2_offload_cdn_nonce").val()},success:a=>{a.success?(this.terminalLog("warning","Bulk offload cancelled by user."),this.showToast(a.data.message,"success"),this.stopBulkProcessing()):this.showToast(a.data.message,"error")},error:()=>{this.showToast("Failed to cancel bulk offload","error")}})},startBulkProcessing(){this.isProcessing=!0,this.bulkStartTime=Date.now(),s("#cfr2-bulk-offload-all").hide(),s("#cfr2-retry-all-failed").hide(),s("#cfr2-cancel-bulk").show(),s("#cfr2-bulk-progress-section").show(),this.terminalLog("info","Starting offload process..."),this.updateProgressDisplay(),this.processNextItem(),this.progressInterval=setInterval(()=>{this.updateElapsedTime()},1e3)},stopBulkProcessing(){this.isProcessing=!1,this.progressInterval&&(clearInterval(this.progressInterval),this.progressInterval=null),s("#cfr2-bulk-offload-all").show().prop("disabled",!1).text("Offload All Media"),s("#cfr2-retry-all-failed").show(),s("#cfr2-cancel-bulk").hide(),this.bulkStartTime=null},processNextItem(){this.isProcessing&&s.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_process_bulk_item",nonce:s("#cloudflare_r2_offload_cdn_nonce").val()},success:e=>{if(e.success){const a=e.data;if(a.done){this.terminalLog("info",a.message),this.terminalLog("info",`Completed: ${this.bulkStats.completed} | Failed: ${this.bulkStats.failed}`),this.showToast("Bulk offload completed","success"),this.stopBulkProcessing();return}const t=a.status==="success"?"success":"error";this.terminalLog(t,`${a.filename} - ${a.message}`),a.status==="success"?this.bulkStats.completed++:this.bulkStats.failed++,this.updateProgressDisplay(),this.processNextItem()}else this.terminalLog("error",e.data.message||"Unknown error"),this.stopBulkProcessing()},error:()=>{this.terminalLog("error","Network error. Retrying in 3 seconds..."),setTimeout(()=>this.processNextItem(),3e3)}})},updateProgressDisplay(){const{completed:e,failed:a,total:t}=this.bulkStats,l=e+a,n=t>0?Math.round(l/t*100):0;s(".cfr2-progress-fill").css("width",n+"%"),s(".cfr2-progress-percentage").text(n+"%"),s(".cfr2-progress-text").html(`<span style="color: #46b450;">✓ ${e}</span> | <span style="color: #dc3232;">✗ ${a}</span> | <span style="color: #646970;">○ ${t-l} remaining</span>`)},updateElapsedTime(){if(this.bulkStartTime){const e=Math.floor((Date.now()-this.bulkStartTime)/1e3),a=Math.floor(e/60),t=e%60;s("#cfr2-elapsed").text(`${a}m ${t}s`)}},terminalLog(e,a){const t=s("#cfr2-terminal-output"),l=new Date().toLocaleTimeString(),o=s(`
        <div class="cfr2-terminal-line cfr2-terminal-${e}">
          <span class="cfr2-terminal-time">[${l}]</span>
          <span class="cfr2-terminal-icon">${{info:"●",success:"✓",error:"✗",warning:"⚠"}[e]||"●"}</span>
          <span class="cfr2-terminal-message">${this.escapeHtml(a)}</span>
        </div>
      `);t.append(o),t.scrollTop(t[0].scrollHeight)},escapeHtml(e){const a=document.createElement("div");return a.textContent=e,a.innerHTML},handleCDNToggle(e){const a=s(e.currentTarget).is(":checked");s(".cdn-fields").toggle(a)},handleSmartSizesToggle(e){const a=s(e.currentTarget).is(":checked");s(".smart-sizes-options").toggle(a)},handleQualityChange(e){const a=s(e.currentTarget).val();s("#quality-value").text(a)},handleDeployWorker(e){e.preventDefault();const a=s(e.currentTarget),t=s("#worker-deploy-result");a.hasClass("is-loading")||(a.addClass("is-loading").prop("disabled",!0),t.html('<span class="spinner is-active" style="float:none;margin:0 5px;"></span>'),s.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_deploy_worker",nonce:s("#cloudflare_r2_offload_cdn_nonce").val()},success:l=>{l.success?(t.html('<span style="color: #46b450;">✓ '+l.data.message+"</span>"),this.showToast(l.data.message,"success"),s("#remove-worker").show(),setTimeout(()=>location.reload(),1500)):(t.html('<span style="color: #dc3232;">✗ '+l.data.message+"</span>"),this.showToast(l.data.message,"error"))},error:()=>{t.html('<span style="color: #dc3232;">✗ Deployment failed</span>'),this.showToast("Worker deployment failed","error")},complete:()=>{a.removeClass("is-loading").prop("disabled",!1)}}))},handleRemoveWorker(e){if(e.preventDefault(),!confirm("Remove deployed Worker? This will disable CDN URL rewriting."))return;const a=s(e.currentTarget),t=s("#worker-deploy-result");a.hasClass("is-loading")||(a.addClass("is-loading").prop("disabled",!0),t.html('<span class="spinner is-active" style="float:none;margin:0 5px;"></span>'),s.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_remove_worker",nonce:s("#cloudflare_r2_offload_cdn_nonce").val()},success:l=>{l.success?(t.html('<span style="color: #46b450;">✓ '+l.data.message+"</span>"),this.showToast(l.data.message,"success"),a.hide(),setTimeout(()=>location.reload(),1500)):(t.html('<span style="color: #dc3232;">✗ '+l.data.message+"</span>"),this.showToast(l.data.message,"error"))},error:()=>{t.html('<span style="color: #dc3232;">✗ Remove failed</span>'),this.showToast("Worker removal failed","error")},complete:()=>{a.removeClass("is-loading").prop("disabled",!1)}}))},loadActivityLog(){s.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_get_activity_log",nonce:s("#cloudflare_r2_offload_cdn_nonce").val(),limit:50},success:e=>{if(e.success&&e.data.logs.length>0){const a=s("#cfr2-terminal-output");a.children().length<=1&&(e.data.logs.reverse().forEach(t=>{const l=t.status==="success"?"success":"error",n=new Date(t.timestamp*1e3).toLocaleTimeString(),i=s(`
                  <div class="cfr2-terminal-line cfr2-terminal-${l}">
                    <span class="cfr2-terminal-time">[${n}]</span>
                    <span class="cfr2-terminal-icon">${{success:"✓",error:"✗"}[l]}</span>
                    <span class="cfr2-terminal-message">${this.escapeHtml(t.filename)} - ${this.escapeHtml(t.message)}</span>
                  </div>
                `);a.append(i)}),a.scrollTop(a[0].scrollHeight))}}})},checkBulkProgress(){s.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_get_bulk_progress",nonce:s("#cloudflare_r2_offload_cdn_nonce").val()},success:e=>{e.success&&e.data.is_running&&(this.terminalLog("info","Resuming pending offload..."),this.bulkStats={completed:e.data.completed,failed:e.data.failed,total:e.data.total},this.startBulkProcessing())}})},loadFailedItems(){},handleRetryFailed(e){e.preventDefault(),confirm("Retry all failed items?")&&s.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_retry_failed",nonce:s("#cloudflare_r2_offload_cdn_nonce").val()},success:a=>{a.success?(this.terminalLog("info",`Queued ${a.data.queued} items for retry.`),this.bulkStats={completed:0,failed:0,total:a.data.queued},this.startBulkProcessing()):this.showToast(a.data.message,"error")},error:()=>{this.showToast("Failed to retry items","error")}})},handleRetrySingle(e){e.preventDefault();const a=s(e.currentTarget).data("attachment-id");s.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_retry_single",nonce:s("#cloudflare_r2_offload_cdn_nonce").val(),attachment_id:a},success:t=>{t.success?(this.showToast(t.data.message,"success"),s(e.currentTarget).closest(".cfr2-error-item").fadeOut()):this.showToast(t.data.message,"error")},error:()=>{this.showToast("Failed to retry item","error")}})},handleAttachmentOffload(e){e.preventDefault();const a=s(e.currentTarget),t=a.data("id"),l=a.data("nonce"),n=a.siblings(".cfr2-offload-status");a.prop("disabled",!0).text("Offloading..."),n.html('<span class="spinner is-active" style="float: none;"></span>'),s.ajax({url:ajaxurl,type:"POST",data:{action:"cfr2_offload_attachment",attachment_id:t,nonce:l},success:o=>{o.success?(n.html('<span style="color: #46b450;">✓ '+o.data.message+"</span>"),a.hide(),setTimeout(()=>{a.closest("td").find("span").first().html('<span style="color: #46b450; font-weight: bold;"><span class="dashicons dashicons-cloud" style="vertical-align: middle;"></span> Offloaded to R2</span>'+(o.data.url?'<br><small style="color: #666;">'+o.data.url+"</small>":"")),n.empty()},2e3)):(n.html('<span style="color: #dc3232;">✗ '+o.data.message+"</span>"),a.prop("disabled",!1).text("Offload to R2"))},error:()=>{n.html('<span style="color: #dc3232;">✗ Request failed</span>'),a.prop("disabled",!1).text("Offload to R2")}})},handleClearLog(e){e.preventDefault(),confirm("Clear process log?")&&s.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_clear_log",nonce:s("#cloudflare_r2_offload_cdn_nonce").val()},success:a=>{a.success?(this.showToast(a.data.message,"success"),s("#cfr2-terminal-output").html(`
              <div class="cfr2-terminal-line cfr2-terminal-info">
                <span class="cfr2-terminal-prompt">$</span>
                <span>Ready. Click "Offload All Media" to start.</span>
              </div>
            `)):this.showToast(a.data.message,"error")},error:()=>{this.showToast("Failed to clear log","error")}})},handleGotoBulkActions(e){e.preventDefault(),s('.cloudflare-r2-offload-cdn-tabs li[data-tab="bulk-actions"]').trigger("click")},handleValidateCdnDns(e){e.preventDefault();const a=s(e.currentTarget),t=s("#cdn-dns-status"),l=s("#cdn_url").val();if(!l){this.showToast("Please enter a CDN URL first","error");return}a.hasClass("is-loading")||(a.addClass("is-loading").prop("disabled",!0).text("Validating..."),t.show().html('<span class="spinner is-active" style="float:none;margin:0 5px;"></span> Checking DNS...'),s.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_validate_cdn_dns",nonce:s("#cloudflare_r2_offload_cdn_nonce").val(),cdn_url:l},success:n=>{if(n.success){const o=n.data;o.action==="created"?(t.html('<div class="cfr2-dns-success"><span class="dashicons dashicons-yes-alt" style="color: #46b450;"></span> '+o.message+"</div>"),this.showToast(o.message,"success")):o.action==="exists"&&(o.warnings&&o.warnings.length>0?(t.html('<div class="cfr2-dns-warning"><span class="dashicons dashicons-warning" style="color: #dba617;"></span> '+o.warnings.join("<br>")+'<br><button type="button" class="button cfr2-enable-proxy-btn" data-zone-id="'+o.zone_id+'" data-record-id="'+o.record_id+'">Enable Proxy Now</button></div>'),this.showToast("DNS record found but needs configuration","error")):(t.html('<div class="cfr2-dns-success"><span class="dashicons dashicons-yes-alt" style="color: #46b450;"></span> DNS record found with proxy enabled. Ready to deploy!</div>'),this.showToast("DNS validation passed!","success")))}else t.html('<div class="cfr2-dns-error"><span class="dashicons dashicons-dismiss" style="color: #dc3232;"></span> '+n.data.message+"</div>"),this.showToast(n.data.message,"error")},error:()=>{t.html('<div class="cfr2-dns-error"><span class="dashicons dashicons-dismiss" style="color: #dc3232;"></span> Validation request failed</div>'),this.showToast("DNS validation failed","error")},complete:()=>{a.removeClass("is-loading").prop("disabled",!1).text("Validate DNS")}}))},handleEnableDnsProxy(e){e.preventDefault();const a=s(e.currentTarget),t=a.data("zone-id"),l=a.data("record-id"),n=s("#cdn-dns-status");a.hasClass("is-loading")||(a.addClass("is-loading").prop("disabled",!0).text("Enabling..."),s.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_enable_dns_proxy",nonce:s("#cloudflare_r2_offload_cdn_nonce").val(),zone_id:t,record_id:l},success:o=>{o.success?(n.html('<div class="cfr2-dns-success"><span class="dashicons dashicons-yes-alt" style="color: #46b450;"></span> '+o.data.message+" Ready to deploy!</div>"),this.showToast(o.data.message,"success")):(this.showToast(o.data.message,"error"),a.removeClass("is-loading").prop("disabled",!1).text("Enable Proxy Now"))},error:()=>{this.showToast("Failed to enable proxy","error"),a.removeClass("is-loading").prop("disabled",!1).text("Enable Proxy Now")}}))}};s(document).ready(()=>{r.init()})})(jQuery);
//# sourceMappingURL=admin.js.map
