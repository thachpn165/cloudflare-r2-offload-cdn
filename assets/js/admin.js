(function(e){const n={init(){this.cacheElements(),this.bindEvents(),e(".cloudflare-r2-offload-cdn-form-actions").hide(),this.progressInterval=null,this.activityLogInterval=null,this.bulkStartTime=null,this.bulkStats={completed:0,failed:0,total:0},this.isProcessing=!1,this.currentAction="offload"},cacheElements(){this.$tabs=e(".cloudflare-r2-offload-cdn-tabs li"),this.$tabContents=e(".cloudflare-r2-offload-cdn-tab-content"),this.$form=e("#cloudflare-r2-offload-cdn-settings-form"),this.$saveBtn=e(".cloudflare-r2-offload-cdn-save-btn"),this.$toast=e("#cloudflare-r2-offload-cdn-toast")},bindEvents(){this.$tabs.on("click",this.handleTabClick.bind(this)),this.$form.on("submit",this.handleFormSubmit.bind(this)),e(document).on("click",".cloudflare-r2-offload-cdn-accordion-header",this.handleAccordionClick),e("#test-r2-connection").on("click",this.handleTestR2Connection.bind(this)),e("#cfr2-bulk-offload-all").on("click",this.handleBulkOffload.bind(this)),e("#cfr2-bulk-restore-all").on("click",this.handleBulkRestore.bind(this)),e("#cfr2-bulk-delete-local").on("click",this.handleBulkDeleteLocal.bind(this)),e("#cfr2-cancel-bulk").on("click",this.handleCancelBulk.bind(this)),e("#cdn_enabled").on("change",this.handleCDNToggle.bind(this)),e("#smart_sizes").on("change",this.handleSmartSizesToggle.bind(this)),e("#quality").on("input",this.handleQualityChange.bind(this)),e("#deploy-worker").on("click",this.handleDeployWorker.bind(this)),e("#remove-worker").on("click",this.handleRemoveWorker.bind(this)),e("#cfr2-retry-all-failed").on("click",this.handleRetryFailed.bind(this)),e("#cfr2-retry-all").on("click",this.handleRetryFailed.bind(this)),e("#cfr2-clear-log").on("click",this.handleClearLog.bind(this)),e(document).on("click",".cfr2-retry-single",this.handleRetrySingle.bind(this)),e("#goto-bulk-actions").on("click",this.handleGotoBulkActions.bind(this)),e(document).on("click",".cfr2-offload-btn",this.handleAttachmentOffload.bind(this)),e("#validate-cdn-dns").on("click",this.handleValidateCdnDns.bind(this)),e(document).on("click",".cfr2-enable-proxy-btn",this.handleEnableDnsProxy.bind(this))},handleTabClick(t){const a=e(t.currentTarget),s=a.data("tab");this.$tabs.removeClass("active"),a.addClass("active"),this.$tabContents.removeClass("active"),e("#tab-"+s).addClass("active"),e(".cloudflare-r2-offload-cdn-form-actions").toggle(s!=="dashboard"&&s!=="bulk-actions"),s==="bulk-actions"&&(this.loadActivityLog(),this.refreshButtonCounts(),this.checkBulkProgress())},handleAccordionClick(t){const a=e(t.currentTarget),s=a.next(".cloudflare-r2-offload-cdn-accordion-content");a.toggleClass("active"),s.toggleClass("active")},handleFormSubmit(t){if(t.preventDefault(),this.$saveBtn.hasClass("is-loading"))return;this.setLoading(!0);const a=this.$form.serialize();e.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:a+"&action=cloudflare_r2_offload_cdn_save_settings",success:this.handleSaveSuccess.bind(this),error:this.handleSaveError.bind(this),complete:()=>this.setLoading(!1)})},handleSaveSuccess(t){t.success?this.showToast(t.data.message,"success"):this.showToast(t.data.message||myPluginAdmin.strings.error,"error")},handleSaveError(){this.showToast(myPluginAdmin.strings.error,"error")},setLoading(t){this.$saveBtn.toggleClass("is-loading",t)},showToast(t,a="success"){const s=a==="success"?"yes-alt":"warning",l=e("<div>",{class:`cloudflare-r2-offload-cdn-toast-item ${a}`}).append(e("<span>",{class:`dashicons dashicons-${s}`}),e("<span>").text(t));this.$toast.append(l),setTimeout(()=>{l.addClass("fade-out"),setTimeout(()=>l.remove(),300)},3e3)},handleTestR2Connection(t){t.preventDefault();const a=e(t.currentTarget),s=e("#r2-connection-result");a.hasClass("is-loading")||(a.addClass("is-loading").prop("disabled",!0),s.html('<span class="spinner is-active" style="float:none;margin:0 5px;"></span>'),e.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cloudflare_r2_offload_cdn_test_r2",cloudflare_r2_offload_cdn_nonce:e("#cloudflare_r2_offload_cdn_nonce").val(),r2_account_id:e("#r2_account_id").val(),r2_access_key_id:e("#r2_access_key_id").val(),r2_secret_access_key:e("#r2_secret_access_key").val(),r2_bucket:e("#r2_bucket").val()},success:l=>{l.success?(s.html('<span style="color: #46b450;">✓ '+l.data.message+"</span>"),this.showToast(l.data.message,"success")):(s.html('<span style="color: #dc3232;">✗ '+l.data.message+"</span>"),this.showToast(l.data.message,"error"))},error:()=>{s.html('<span style="color: #dc3232;">✗ Connection failed</span>'),this.showToast("Connection test failed","error")},complete:()=>{a.removeClass("is-loading").prop("disabled",!1)}}))},handleBulkOffload(t){if(t.preventDefault(),!confirm("Queue all media files for offload to R2?"))return;const a=e(t.currentTarget);a.prop("disabled",!0).text("Queuing..."),e.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_bulk_offload_all",nonce:e("#cloudflare_r2_offload_cdn_nonce").val()},success:s=>{s.success?(this.terminalLog("info",`Queued ${s.data.total} files for offload.`),this.bulkStats={completed:0,failed:0,total:s.data.total},this.startBulkProcessing()):(this.terminalLog("error",s.data.message),this.showToast(s.data.message,"error"),a.prop("disabled",!1).text("Offload All Media"))},error:()=>{this.terminalLog("error","Failed to queue files."),this.showToast("Failed to start bulk offload","error"),a.prop("disabled",!1).text("Offload All Media")}})},handleBulkRestore(t){if(t.preventDefault(),!confirm("Restore all media files from R2 to local?"))return;const a=e(t.currentTarget);a.prop("disabled",!0).text("Queuing..."),e.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_bulk_restore_all",nonce:e("#cloudflare_r2_offload_cdn_nonce").val()},success:s=>{s.success?(this.terminalLog("info",`Queued ${s.data.total} files for restore.`),this.bulkStats={completed:0,failed:0,total:s.data.total},this.currentAction="restore",this.startBulkProcessing()):(this.terminalLog("error",s.data.message),this.showToast(s.data.message,"error"),a.prop("disabled",!1).text(a.data("original-text")||"Restore All"))},error:()=>{this.terminalLog("error","Failed to queue files for restore."),this.showToast("Failed to start bulk restore","error"),a.prop("disabled",!1).text(a.data("original-text")||"Restore All")}})},handleBulkDeleteLocal(t){if(t.preventDefault(),!confirm("Delete local files for all offloaded media? Files will remain on R2. This cannot be undone."))return;const a=e(t.currentTarget);a.prop("disabled",!0).text("Queuing..."),e.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_bulk_delete_local",nonce:e("#cloudflare_r2_offload_cdn_nonce").val()},success:s=>{s.success?(this.terminalLog("info",`Queued ${s.data.total} files for local deletion.`),this.bulkStats={completed:0,failed:0,total:s.data.total},this.currentAction="delete_local",this.startBulkProcessing()):(this.terminalLog("error",s.data.message),this.showToast(s.data.message,"error"),a.prop("disabled",!1).text(a.data("original-text")||"Free Disk Space"))},error:()=>{this.terminalLog("error","Failed to queue files for deletion."),this.showToast("Failed to start bulk delete","error"),a.prop("disabled",!1).text(a.data("original-text")||"Free Disk Space")}})},handleCancelBulk(t){t.preventDefault(),confirm("Cancel bulk operation?")&&e.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_cancel_bulk",nonce:e("#cloudflare_r2_offload_cdn_nonce").val()},success:a=>{a.success?(this.terminalLog("warning","Bulk operation cancelled by user."),this.showToast(a.data.message,"success"),this.stopBulkProcessing()):this.showToast(a.data.message,"error")},error:()=>{this.showToast("Failed to cancel bulk operation","error")}})},startBulkProcessing(){this.isProcessing=!0,this.bulkStartTime=Date.now(),e("#cfr2-bulk-offload-all").hide(),e("#cfr2-bulk-restore-all").hide(),e("#cfr2-bulk-delete-local").hide(),e("#cfr2-retry-all-failed").hide(),e("#cfr2-cancel-bulk").show(),e("#cfr2-bulk-progress-section").show();const a={offload:"offload",restore:"restore",delete_local:"local file deletion"}[this.currentAction]||"offload";this.terminalLog("info",`Starting ${a} process...`),this.updateProgressDisplay(),this.processNextItem(),this.progressInterval=setInterval(()=>{this.updateElapsedTime()},1e3)},stopBulkProcessing(){this.isProcessing=!1,this.progressInterval&&(clearInterval(this.progressInterval),this.progressInterval=null),e("#cfr2-bulk-offload-all").show().prop("disabled",!1),e("#cfr2-bulk-restore-all").show().prop("disabled",!1),e("#cfr2-bulk-delete-local").show().prop("disabled",!1),e("#cfr2-retry-all-failed").show(),e("#cfr2-cancel-bulk").hide(),this.bulkStartTime=null,this.currentAction="offload",this.refreshButtonCounts()},refreshButtonCounts(){e.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_get_bulk_counts",nonce:e("#cloudflare_r2_offload_cdn_nonce").val()},success:t=>{if(t.success){const a=t.data,s=e("#cfr2-bulk-offload-all");a.not_offloaded>0?s.show().text(`Offload All Media (${a.not_offloaded})`):s.hide();const l=e("#cfr2-bulk-restore-all");a.offloaded>0?l.show().text(`Restore All (${a.offloaded})`):l.hide();const r=e("#cfr2-bulk-delete-local");a.disk_saveable>0?r.show().text(`Free Disk Space (${a.disk_saveable})`):r.hide()}}})},processNextItem(){if(!this.isProcessing)return;const t={offload:"cfr2_process_bulk_item",restore:"cfr2_process_restore_item",delete_local:"cfr2_process_delete_local_item"},a={offload:"offload",restore:"restore",delete_local:"delete local"},s=t[this.currentAction]||"cfr2_process_bulk_item",l=a[this.currentAction]||"offload";e.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:s,nonce:e("#cloudflare_r2_offload_cdn_nonce").val()},success:r=>{if(r.success){const o=r.data;if(o.done){this.terminalLog("info",o.message),this.terminalLog("info",`Completed: ${this.bulkStats.completed} | Failed: ${this.bulkStats.failed}`),this.showToast(`Bulk ${l} completed`,"success"),this.stopBulkProcessing();return}const i=o.status==="success"?"success":"error";this.terminalLog(i,`${o.filename} - ${o.message}`),o.status==="success"?this.bulkStats.completed++:this.bulkStats.failed++,this.updateProgressDisplay(),this.processNextItem()}else this.terminalLog("error",r.data.message||"Unknown error"),this.stopBulkProcessing()},error:()=>{this.terminalLog("error","Network error. Retrying in 3 seconds..."),setTimeout(()=>this.processNextItem(),3e3)}})},updateProgressDisplay(){const{completed:t,failed:a,total:s}=this.bulkStats,l=t+a,r=s>0?Math.round(l/s*100):0;e(".cfr2-progress-fill").css("width",r+"%"),e(".cfr2-progress-percentage").text(r+"%"),e(".cfr2-progress-text").html(`<span style="color: #46b450;">✓ ${t}</span> | <span style="color: #dc3232;">✗ ${a}</span> | <span style="color: #646970;">○ ${s-l} remaining</span>`)},updateElapsedTime(){if(this.bulkStartTime){const t=Math.floor((Date.now()-this.bulkStartTime)/1e3),a=Math.floor(t/60),s=t%60;e("#cfr2-elapsed").text(`${a}m ${s}s`)}},terminalLog(t,a){const s=e("#cfr2-terminal-output"),l=new Date().toLocaleTimeString(),o=e(`
        <div class="cfr2-terminal-line cfr2-terminal-${t}">
          <span class="cfr2-terminal-time">[${l}]</span>
          <span class="cfr2-terminal-icon">${{info:"●",success:"✓",error:"✗",warning:"⚠"}[t]||"●"}</span>
          <span class="cfr2-terminal-message">${this.escapeHtml(a)}</span>
        </div>
      `);s.append(o),s.scrollTop(s[0].scrollHeight)},escapeHtml(t){const a=document.createElement("div");return a.textContent=t,a.innerHTML},handleCDNToggle(t){const a=e(t.currentTarget).is(":checked");e(".cdn-fields").toggle(a)},handleSmartSizesToggle(t){const a=e(t.currentTarget).is(":checked");e(".smart-sizes-options").toggle(a)},handleQualityChange(t){const a=e(t.currentTarget).val();e("#quality-value").text(a)},handleDeployWorker(t){t.preventDefault();const a=e(t.currentTarget),s=e("#worker-deploy-result");a.hasClass("is-loading")||(a.addClass("is-loading").prop("disabled",!0),s.html('<span class="spinner is-active" style="float:none;margin:0 5px;"></span>'),e.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_deploy_worker",nonce:e("#cloudflare_r2_offload_cdn_nonce").val()},success:l=>{l.success?(s.html('<span style="color: #46b450;">✓ '+l.data.message+"</span>"),this.showToast(l.data.message,"success"),e("#remove-worker").show(),setTimeout(()=>location.reload(),1500)):(s.html('<span style="color: #dc3232;">✗ '+l.data.message+"</span>"),this.showToast(l.data.message,"error"))},error:()=>{s.html('<span style="color: #dc3232;">✗ Deployment failed</span>'),this.showToast("Worker deployment failed","error")},complete:()=>{a.removeClass("is-loading").prop("disabled",!1)}}))},handleRemoveWorker(t){if(t.preventDefault(),!confirm("Remove deployed Worker? This will disable CDN URL rewriting."))return;const a=e(t.currentTarget),s=e("#worker-deploy-result");a.hasClass("is-loading")||(a.addClass("is-loading").prop("disabled",!0),s.html('<span class="spinner is-active" style="float:none;margin:0 5px;"></span>'),e.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_remove_worker",nonce:e("#cloudflare_r2_offload_cdn_nonce").val()},success:l=>{l.success?(s.html('<span style="color: #46b450;">✓ '+l.data.message+"</span>"),this.showToast(l.data.message,"success"),a.hide(),setTimeout(()=>location.reload(),1500)):(s.html('<span style="color: #dc3232;">✗ '+l.data.message+"</span>"),this.showToast(l.data.message,"error"))},error:()=>{s.html('<span style="color: #dc3232;">✗ Remove failed</span>'),this.showToast("Worker removal failed","error")},complete:()=>{a.removeClass("is-loading").prop("disabled",!1)}}))},loadActivityLog(){e.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_get_activity_log",nonce:e("#cloudflare_r2_offload_cdn_nonce").val(),limit:50},success:t=>{if(t.success&&t.data.logs.length>0){const a=e("#cfr2-terminal-output");a.children().length<=1&&(t.data.logs.reverse().forEach(s=>{const l=s.status==="success"?"success":"error",r=new Date(s.timestamp*1e3).toLocaleTimeString(),i=e(`
                  <div class="cfr2-terminal-line cfr2-terminal-${l}">
                    <span class="cfr2-terminal-time">[${r}]</span>
                    <span class="cfr2-terminal-icon">${{success:"✓",error:"✗"}[l]}</span>
                    <span class="cfr2-terminal-message">${this.escapeHtml(s.filename)} - ${this.escapeHtml(s.message)}</span>
                  </div>
                `);a.append(i)}),a.scrollTop(a[0].scrollHeight))}}})},checkBulkProgress(){},loadFailedItems(){},handleRetryFailed(t){t.preventDefault(),confirm("Retry all failed items?")&&e.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_retry_failed",nonce:e("#cloudflare_r2_offload_cdn_nonce").val()},success:a=>{a.success?(this.terminalLog("info",`Queued ${a.data.queued} items for retry.`),this.bulkStats={completed:0,failed:0,total:a.data.queued},this.startBulkProcessing()):this.showToast(a.data.message,"error")},error:()=>{this.showToast("Failed to retry items","error")}})},handleRetrySingle(t){t.preventDefault();const a=e(t.currentTarget).data("attachment-id");e.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_retry_single",nonce:e("#cloudflare_r2_offload_cdn_nonce").val(),attachment_id:a},success:s=>{s.success?(this.showToast(s.data.message,"success"),e(t.currentTarget).closest(".cfr2-error-item").fadeOut()):this.showToast(s.data.message,"error")},error:()=>{this.showToast("Failed to retry item","error")}})},handleAttachmentOffload(t){t.preventDefault();const a=e(t.currentTarget),s=a.data("id"),l=a.data("nonce"),r=a.siblings(".cfr2-offload-status");a.prop("disabled",!0).text("Offloading..."),r.html('<span class="spinner is-active" style="float: none;"></span>'),e.ajax({url:ajaxurl,type:"POST",data:{action:"cfr2_offload_attachment",attachment_id:s,nonce:l},success:o=>{o.success?(r.html('<span style="color: #46b450;">✓ '+o.data.message+"</span>"),a.hide(),setTimeout(()=>{a.closest("td").find("span").first().html('<span style="color: #46b450; font-weight: bold;"><span class="dashicons dashicons-cloud" style="vertical-align: middle;"></span> Offloaded to R2</span>'+(o.data.url?'<br><small style="color: #666;">'+o.data.url+"</small>":"")),r.empty()},2e3)):(r.html('<span style="color: #dc3232;">✗ '+o.data.message+"</span>"),a.prop("disabled",!1).text("Offload to R2"))},error:()=>{r.html('<span style="color: #dc3232;">✗ Request failed</span>'),a.prop("disabled",!1).text("Offload to R2")}})},handleClearLog(t){t.preventDefault(),confirm("Clear process log?")&&e.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_clear_log",nonce:e("#cloudflare_r2_offload_cdn_nonce").val()},success:a=>{a.success?(this.showToast(a.data.message,"success"),e("#cfr2-terminal-output").html(`
              <div class="cfr2-terminal-line cfr2-terminal-info">
                <span class="cfr2-terminal-prompt">$</span>
                <span>Ready. Click "Offload All Media" to start.</span>
              </div>
            `)):this.showToast(a.data.message,"error")},error:()=>{this.showToast("Failed to clear log","error")}})},handleGotoBulkActions(t){t.preventDefault(),e('.cloudflare-r2-offload-cdn-tabs li[data-tab="bulk-actions"]').trigger("click")},handleValidateCdnDns(t){t.preventDefault();const a=e(t.currentTarget),s=e("#cdn-dns-status"),l=e("#cdn_url").val();if(!l){this.showToast("Please enter a CDN URL first","error");return}a.hasClass("is-loading")||(a.addClass("is-loading").prop("disabled",!0).text("Validating..."),s.show().html('<span class="spinner is-active" style="float:none;margin:0 5px;"></span> Checking DNS...'),e.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_validate_cdn_dns",nonce:e("#cloudflare_r2_offload_cdn_nonce").val(),cdn_url:l},success:r=>{if(r.success){const o=r.data;o.action==="created"?(s.html('<div class="cfr2-dns-success"><span class="dashicons dashicons-yes-alt" style="color: #46b450;"></span> '+o.message+"</div>"),this.showToast(o.message,"success")):o.action==="exists"&&(o.warnings&&o.warnings.length>0?(s.html('<div class="cfr2-dns-warning"><span class="dashicons dashicons-warning" style="color: #dba617;"></span> '+o.warnings.join("<br>")+'<br><button type="button" class="button cfr2-enable-proxy-btn" data-zone-id="'+o.zone_id+'" data-record-id="'+o.record_id+'">Enable Proxy Now</button></div>'),this.showToast("DNS record found but needs configuration","error")):(s.html('<div class="cfr2-dns-success"><span class="dashicons dashicons-yes-alt" style="color: #46b450;"></span> DNS record found with proxy enabled. Ready to deploy!</div>'),this.showToast("DNS validation passed!","success")))}else s.html('<div class="cfr2-dns-error"><span class="dashicons dashicons-dismiss" style="color: #dc3232;"></span> '+r.data.message+"</div>"),this.showToast(r.data.message,"error")},error:()=>{s.html('<div class="cfr2-dns-error"><span class="dashicons dashicons-dismiss" style="color: #dc3232;"></span> Validation request failed</div>'),this.showToast("DNS validation failed","error")},complete:()=>{a.removeClass("is-loading").prop("disabled",!1).text("Validate DNS")}}))},handleEnableDnsProxy(t){t.preventDefault();const a=e(t.currentTarget),s=a.data("zone-id"),l=a.data("record-id"),r=e("#cdn-dns-status");a.hasClass("is-loading")||(a.addClass("is-loading").prop("disabled",!0).text("Enabling..."),e.ajax({url:myPluginAdmin.ajaxUrl,type:"POST",data:{action:"cfr2_enable_dns_proxy",nonce:e("#cloudflare_r2_offload_cdn_nonce").val(),zone_id:s,record_id:l},success:o=>{o.success?(r.html('<div class="cfr2-dns-success"><span class="dashicons dashicons-yes-alt" style="color: #46b450;"></span> '+o.data.message+" Ready to deploy!</div>"),this.showToast(o.data.message,"success")):(this.showToast(o.data.message,"error"),a.removeClass("is-loading").prop("disabled",!1).text("Enable Proxy Now"))},error:()=>{this.showToast("Failed to enable proxy","error"),a.removeClass("is-loading").prop("disabled",!1).text("Enable Proxy Now")}}))}};e(document).ready(()=>{n.init()})})(jQuery);
//# sourceMappingURL=admin.js.map
